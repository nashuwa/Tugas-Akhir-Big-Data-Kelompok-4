<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Saham</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans flex">

  <!-- Sidebar -->
  <aside class="w-64 bg-[#f8f9fc] border-r border-gray-200 min-h-screen flex flex-col">
    <div class="p-6 flex items-center space-x-3">
      <div class="bg-rose-400 text-white font-bold rounded-full h-8 w-8 flex items-center justify-center">D</div>
      <span class="text-rose-500 font-bold tracking-wide uppercase">Dashboard</span>
    </div>
    <hr class="border-gray-200">
    <div class="px-6 mt-4 text-xs text-gray-500 tracking-wide uppercase">Menu</div>
    <nav class="mt-2 flex-1 px-4 space-y-2">
      <a href="{{ url_for('idx') }}" class="flex items-center space-x-2 px-3 py-2 text-sm text-gray-500 rounded-md hover:bg-white">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2M9 17H7v-7h2zm4 0h-2V7h2zm4 0h-2v-4h2z"/></svg>
        <span>IDX</span>
      </a>
      <a href="{{ url_for('yfinance') }}" class="flex items-center space-x-2 px-3 py-2 text-sm font-semibold text-rose-400 bg-white rounded-md hover:bg-rose-50">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 32 32"><path d="M4 7a1 1 0 0 0 0 2h2.22l2.624 10.5c.223.89 1.02 1.5 1.937 1.5h12.47c.903 0 1.67-.6 1.907-1.47L27.75 10h-2.094l-2.406 9H10.78L8.157 8.5A1.984 1.984 0 0 0 6.22 7zm18 14c-1.645 0-3 1.355-3 3s1.355 3 3 3s3-1.355 3-3s-1.355-3-3-3m-9 0c-1.645 0-3 1.355-3 3s1.355 3 3 3s3-1.355 3-3s-1.355-3-3-3m3-14v5h-3l4 4l4-4h-3V7zm-3 16c.564 0 1 .436 1 1s-.436 1-1 1s-1-.436-1-1s.436-1 1-1m9 0c.564 0 1 .436 1 1s-.436 1-1 1s-1-.436-1-1s.436-1 1-1"/></svg>
        <span>Yfinance</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-3 py-2 text-sm text-gray-500 rounded-md hover:bg-white">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M2 4a1 1 0 0 1 1-1h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1zm2 1v14h16V5zm2 2h6v6H6zm2 2v2h2V9zm6 0h4V7h-4zm4 4h-4v-2h4zM6 15v2h12v-2z"/></svg>
        <span>IQ Plus</span>
      </a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8 overflow-auto">
    <div class="">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">Dashboard Saham</h2>

      <!-- Ticker Selection -->
      <div class="mb-6">
        <label for="ticker-select" class="block text-gray-700 mb-2">Pilih Ticker:</label>
        <select id="ticker-select" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">-- Pilih Ticker --</option>
        </select>
      </div>

      <div id="price-buttons" class="flex gap-2 mt-2">
        <div class="price-btn cursor-pointer px-4 py-2 rounded border border-blue-500 text-blue-500 font-medium bg-blue-100" data-type="close">Close</div>
        <div class="price-btn cursor-pointer px-4 py-2 rounded border border-gray-300 text-gray-700 font-medium bg-white" data-type="open">Open</div>
        <div class="price-btn cursor-pointer px-4 py-2 rounded border border-gray-300 text-gray-700 font-medium bg-white" data-type="high">High</div>
        <div class="price-btn cursor-pointer px-4 py-2 rounded border border-gray-300 text-gray-700 font-medium bg-white" data-type="low">Low</div>
      </div>

      <div id="range-buttons" class="flex gap-2 mt-2">
        <div class="range-btn cursor-pointer px-4 py-2 rounded border border-blue-500 text-blue-500 font-medium bg-blue-100" data-range="3">3 Tahun</div>
        <div class="range-btn cursor-pointer px-4 py-2 rounded border border-gray-300 text-gray-700 font-medium bg-white" data-range="5">5 Tahun</div>
      </div>

      <!-- Chart -->
      <div id="chart-container" class="w-full h-[500px]">
        <canvas id="lineChart" class="w-full h-full"></canvas>
      </div>
    </div>
  </main>

  <script>
  window.onload = function () {
    const selectTicker = document.getElementById("ticker-select");
    const priceButtons = document.querySelectorAll(".price-btn");
    const ctx = document.getElementById("lineChart").getContext("2d");

    let chart;
    let rawData = [];
    let selectedType = "close"; // default harga awal

    // Fetch ticker list
    fetch("/api/tickers")
      .then(res => res.json())
      .then(data => {
        data.forEach(ticker => {
          const option = document.createElement("option");
          option.value = ticker;
          option.textContent = ticker;
          selectTicker.appendChild(option);
        });
      });

    // Fungsi update grafik
    function updateChart(type) {
      if (!rawData.length) return;

      const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                          "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

      const labels = rawData.map(d => {
        const date = new Date(d.date);
        return `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
      });

      const priceData = rawData.map(d => d[type]);
      const volumeData = rawData.map(d => d.volume);

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              type: 'line',
              label: `Harga ${type.charAt(0).toUpperCase() + type.slice(1)}`,
              data: priceData,
              borderColor: "blue",
              backgroundColor: "rgba(0, 0, 255, 0.1)",
              yAxisID: 'y',
              borderWidth: 2,
              pointRadius: 0
            },
            {
              type: 'bar',
              label: 'Volume',
              data: volumeData,
              backgroundColor: "rgba(128, 128, 128, 0.3)",
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { maxTicksLimit: 10 },
              title: { display: true, text: "Bulan" }
            },
            y: {
              beginAtZero: false,
              position: 'left',
              title: { display: true, text: `Harga (${type})` }
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              grid: { drawOnChartArea: false },
              title: { display: true, text: "Volume" }
            }
          },
          plugins: {
            legend: { display: true },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          }
        }
      });
    }

    // Saat ticker berubah
    selectTicker.addEventListener("change", function () {
      const ticker = this.value;
      if (!ticker) return;

      fetch(`/api/stock/${ticker}`)
        .then(res => res.json())
        .then(data => {
          rawData = data;
          updateChart(selectedType); // pakai yang dipilih terakhir
        });
    });

    // Saat tombol harga diklik
    priceButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        selectedType = btn.dataset.type;

        // Reset semua tombol
        priceButtons.forEach(b => {
          b.classList.remove("bg-blue-100", "border-blue-500", "text-blue-500");
          b.classList.add("bg-white", "border-gray-300", "text-gray-700");
        });

        // Aktifkan tombol yang dipilih
        btn.classList.remove("bg-white", "border-gray-300", "text-gray-700");
        btn.classList.add("bg-blue-100", "border-blue-500", "text-blue-500");

        updateChart(selectedType);
      });
    });
  };
</script>


</body>
</html>
