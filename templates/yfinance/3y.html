{% extends 'index.html' %}

{% block content %}
<main class="flex-1 p-8 overflow-auto">
  <div>
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Grafik Saham</h2>

    <!-- Dropdown pilih ticker -->
    <label for="ticker-select" class="block text-sm mb-2">Pilih Ticker:</label>
    <select id="ticker-select" class="p-2 border rounded mb-4">
      <option value="">-- Pilih Ticker --</option>
    </select>

    <!-- Chart -->
    <div class="w-full h-[500px]">
      <canvas id="stockChart"></canvas>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const select = document.getElementById("ticker-select");
  const ctx = document.getElementById("stockChart").getContext("2d");
  let chart;

  // Fetch list ticker
  fetch("/api/tickers")
    .then(res => res.json())
    .then(data => {
      data.forEach(ticker => {
        const opt = document.createElement("option");
        opt.value = ticker;
        opt.textContent = ticker;
        select.appendChild(opt);
      });
    });

  // Fetch & tampilkan grafik saat ticker dipilih
  select.addEventListener("change", () => {
    const ticker = select.value;
    if (!ticker) return;

    fetch(`/api/stock/${ticker}`)
      .then(res => res.json())
      .then(data => {
        const labels = data.map(d => d.Bulan);
        const open = data.map(d => d.open);
        const close = data.map(d => d.close);
        const high = data.map(d => d.high);
        const low = data.map(d => d.low);
        const avgVolume = data.map(d => d.avgVolume);
        const maxVolume = data.map(d => d.maxVolume);

        if (chart) chart.destroy();

        chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                type: "line",
                label: "Open",
                data: open,
                borderColor: "blue",
                borderWidth: 2,
                fill: false,
                yAxisID: "y",
              },
              {
                type: "line",
                label: "Close",
                data: close,
                borderColor: "green",
                borderWidth: 2,
                fill: false,
                yAxisID: "y",
              },
              {
                type: "line",
                label: "High",
                data: high,
                borderColor: "orange",
                borderWidth: 2,
                fill: false,
                yAxisID: "y",
              },
              {
                type: "line",
                label: "Low",
                data: low,
                borderColor: "red",
                borderWidth: 2,
                fill: false,
                yAxisID: "y",
              },
              {
                type: "bar",
                label: "Avg Volume",
                data: avgVolume,
                backgroundColor: "rgba(100, 100, 255, 0.4)",
                yAxisID: "y1"
              },
              {
                type: "bar",
                label: "Max Volume",
                data: maxVolume,
                backgroundColor: "rgba(150, 150, 150, 0.4)",
                yAxisID: "y1"
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                type: "linear",
                position: "left",
                title: { display: true, text: "Harga (Open, Close, etc)" }
              },
              y1: {
                type: "linear",
                position: "right",
                grid: { drawOnChartArea: false },
                title: { display: true, text: "Volume" }
              },
              x: {
                ticks: { maxTicksLimit: 12 },
              }
            },
            plugins: {
              tooltip: { mode: "index", intersect: false },
              legend: { position: "top" }
            }
          }
        });
      });
  });
});
</script>
{% endblock %}